<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="settings">
    <style type="text/css">
        .setting-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .card-style {
            width: 450px;
            height: 275px;
            margin: 5px;
        }
        .nginx-setting-panel {
            display: flex;
            padding-top: 10px;
            align-items: center;
        }
        .nginx-setting-panel .ivu-input-wrapper{
            flex: 1;
        }
    </style>
    <template id="page-settings">
        <div class="setting-panel">
            <Card class="card-style">
                <p slot="title">
                    <Icon type="ios-film-outline"></Icon>
                    配置原型通过Nginx访问
                </p>
                <a href="#" slot="extra" @click="saveNginx()">
                    <Icon type="ios-loop-strong"></Icon>
                    保存
                </a>
                <Alert show-icon>
                    提示
                    <template slot="desc">可以配置通过Nginx来访问原型文件，避免本服务挂了影响原型访问，Nginx配置可参考README.md，开启后访问原型时将跳转Nginx地址</template>
                </Alert>
                <div class="nginx-setting-panel">
                    <i-switch size="large" v-model="nginx.open">
                        <span slot="open">开启</span>
                        <span slot="close">关闭</span>
                    </i-switch>
                    <i-input style="margin-left:10px;"
                             type="text"
                             maxlength="100"
                             clearable
                             v-model.trim="nginx.url"
                             placeholder="请输入Nginx的地址"></i-input>
                </div>
            </Card>
            <Card class="card-style">
                <p slot="title">
                    <Icon type="ios-lock-outline"></Icon>
                    密码修改
                </p>
                <a href="#" slot="extra" @click="savePassword()">
                    <Icon type="ios-loop-strong"></Icon>
                    保存
                </a>
                <i-form ref="pwdForm"
                        :model="pwdItem"
                        label-width="100"
                        :rules="pwdItemRules" @submit.native.prevent>
                    <form-item label="原密码" prop="oldPassword">
                        <i-input v-model.trim="pwdItem.oldPassword"
                                 type="password"
                                 clearable
                                 maxlength="50"
                                 placeholder="原密码"></i-input>
                    </form-item>
                    <form-item label="新密码" prop="newPassword">
                        <i-input v-model.trim="pwdItem.newPassword"
                                 type="password"
                                 clearable
                                 maxlength="50"
                                 placeholder="新密码"></i-input>
                    </form-item>
                    <form-item label="密码确认" prop="confirmPassword">
                        <i-input v-model.trim="pwdItem.confirmPassword"
                                 type="password"
                                 clearable
                                 maxlength="50"
                                 placeholder="密码确认"></i-input>
                    </form-item>
                </i-form>
            </Card>
        </div>
    </template>
    <script type="text/javascript">
        Vue.component('page-settings', {
            template: '#page-settings',
            data() {
                return {
                    datas: [],
                    nginx: {
                        open: false,
                        url: ''
                    },
                    pwdItem: {
                        oldPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    },
                    pwdItemRules: {
                        oldPassword: [
                            {required: true, message: '原密码不能为空'}
                        ],
                        newPassword: [
                            {required: true, message: '新密码不能为空'},
                            { type: 'string', min: 6, message: '密码不能少于6个字符'}
                        ],
                        confirmPassword: [
                            {required: true, message: '密码确认不能为空'},
                            {
                                validator: (rule, value, callback) => {
                                    if (value !== this.pwdItem.newPassword) {
                                        callback(new Error('两次输入的密码不一致'));
                                        return;
                                    }
                                    callback();
                                }
                            }
                        ]
                    }
                }
            },
            mounted() {
                this.loadSetting();
            },
            methods: {
                loadSetting(){
                    this.$http.get(`/api/v1/setting`)
                        .then(res => {
                            this.nginx.open = Boolean(res.data.nginxOpen);
                            this.nginx.url = res.data.nginxUrl;
                        })
                        .catch(err => {
                            console.error(err);
                            this.$notice.err(err.response.data);
                        });
                },
                saveNginx(){
                    this.$http.patch(`/api/v1/setting/nginx`, {...this.nginx})
                        .then(() => {
                            this.$notice.suc('保存成功');
                        })
                        .catch(err => {
                            console.error(err);
                            this.$notice.err(err.response.data);
                        });
                },
                savePassword() {
                    this.$refs.pwdForm.validate(valid => {
                        if (valid) {
                            this.$http.patch(`/api/v1/user/password`, {...this.pwdItem})
                                .then(() => {
                                    this.$notice.suc('密码修改成功，请重新登录');
                                    setTimeout(()=>{
                                        location.href = '/logout';
                                    }, 2000);
                                })
                                .catch(err => {
                                    console.error(err);
                                    this.$notice.err(err.response.data);
                                });
                        }
                    });
                }
            }
        })
    </script>
</div>
</html>
